---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  labels:
    app: postgres
spec:
  serviceName: postgres
  replicas: 3
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      volumes:
        - name: patroni-config
          emptyDir: {}
      initContainers:
        - name: bootstrap
          image: alpine:3.8
          volumeMounts:
            - name: patroni-config
              mountPath: /patroni-config
          command:
            - sh
            - -c
            - |
              cat > /patroni/postgres.yaml <<EOF
              ---
              bootstrap:
                dcs:
                  postgresql:
                    use_pg_rewind: false
              initdb:
                - auth-host: md5
                - auth-local: trust
                - encoding: UTF8
                - locale: en_US.UTF-8
                - data-checksums
              pg_hba:
                - host all all 0.0.0.0/0 md5
                - host replication ${PATRONI_REPLICATION_USERNAME} ${POD_IP}/16    md5
              restapi:
                connect_address: '${POD_IP}:8008'
              postgresql:
                connect_address: '${POD_IP}:5432'
                authentication:
                  superuser:
                    password: superuser
                  replication:
                    password: replication
                callbacks:
                  on_start: /callback.py
                  on_stop: /callback.py
                  on_role_change: /callback.py
              EOF

      containers:
        - name: postgres
          image: registry.opensource.zalan.do/acid/patroni:latest
          env:
            - {name: ETCD_HOST, value: "etcd"}
            - {name: SCOPE, value: "spike"}
          ports:
            - name: patroni
              containerPort: 8008
            - name: postgres
              containerPort: 5432
          volumeMounts:
            - name: patroni-config
              mountPath: /patroni-config
            - name: pgdata
              mountPath: /home/postgres
  volumeClaimTemplates:
    - metadata:
        name: pgdata
      spec:
        storageClassName: ssd
        accessModes: [ReadWriteOnce]
        resources:
          requests:
            storage: "5Gi"
